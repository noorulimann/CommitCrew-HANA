# Environment Configuration Template

## Development Environment (.env.local)

```bash
# ═══════════════════════════════════════════════════════════════
# CITADEL OF TRUTH - Development Configuration
# ═══════════════════════════════════════════════════════════════

# ─── Database Configuration ──────────────────────────────────
MONGODB_URI=mongodb://localhost:27017/citadel-of-truth

# ─── Email Service Configuration ─────────────────────────────
# Supported services: sendgrid, mailgun, smtp
EMAIL_SERVICE=sendgrid
EMAIL_SERVICE_API_KEY=your_sendgrid_api_key_here
EMAIL_FROM=noreply@citadeloftruth.local
EMAIL_FROM_NAME=Citadel of Truth

# ─── Authentication & Security ───────────────────────────────
# Generate secure tokens:
# node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
ADMIN_TOKEN=dev_admin_token_change_in_production
JWT_SECRET=dev_jwt_secret_change_in_production
JWT_EXPIRY=24h

# ─── Rate Limiting ────────────────────────────────────────────
API_RATE_LIMIT_WINDOW_MS=900000
API_RATE_LIMIT_MAX_REQUESTS=100

# ─── Feature Flags ─────────────────────────────────────────────
ENABLE_CRON=true
ENABLE_AUTH=true
ENABLE_RATE_LIMITING=true
LOG_LEVEL=debug

# ─── CORS Configuration ───────────────────────────────────────
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:3001,http://127.0.0.1:3000

# ─── Monitoring (Optional) ────────────────────────────────────
SENTRY_DSN=
DATADOG_API_KEY=

# ─── Server Configuration ────────────────────────────────────
NODE_ENV=development
PORT=3000
```

## Staging Environment (.env.staging)

```bash
# ═══════════════════════════════════════════════════════════════
# CITADEL OF TRUTH - Staging Configuration
# ═══════════════════════════════════════════════════════════════

# ─── Database Configuration ───────────────────────────────────
MONGODB_URI=mongodb+srv://staging_user:password@cluster.mongodb.net/citadel-staging

# ─── Email Service Configuration ──────────────────────────────
EMAIL_SERVICE=sendgrid
EMAIL_SERVICE_API_KEY=your_staging_sendgrid_key
EMAIL_FROM=staging@citadeloftruth.university
EMAIL_FROM_NAME=Citadel of Truth (Staging)

# ─── Authentication & Security ────────────────────────────────
ADMIN_TOKEN=your_secure_staging_admin_token
JWT_SECRET=your_secure_staging_jwt_secret
JWT_EXPIRY=24h

# ─── Rate Limiting ────────────────────────────────────────────
API_RATE_LIMIT_WINDOW_MS=900000
API_RATE_LIMIT_MAX_REQUESTS=100

# ─── Feature Flags ────────────────────────────────────────────
ENABLE_CRON=true
ENABLE_AUTH=true
ENABLE_RATE_LIMITING=true
LOG_LEVEL=info

# ─── CORS Configuration ───────────────────────────────────────
ALLOWED_ORIGINS=https://staging.citadeloftruth.university

# ─── Monitoring ──────────────────────────────────────────────
SENTRY_DSN=your_sentry_dsn_key
DATADOG_API_KEY=your_datadog_key

# ─── Server Configuration ────────────────────────────────────
NODE_ENV=staging
PORT=3000
```

## Production Environment (.env.production)

```bash
# ═══════════════════════════════════════════════════════════════
# CITADEL OF TRUTH - Production Configuration
# ═══════════════════════════════════════════════════════════════

# ─── Database Configuration ───────────────────────────────────
# Use MongoDB Atlas or secure database service
MONGODB_URI=mongodb+srv://prod_user:secure_password@prod-cluster.mongodb.net/citadel-of-truth
MONGODB_POOL_SIZE=10
MONGODB_REPLICA_SET=rs0

# ─── Email Service Configuration ──────────────────────────────
EMAIL_SERVICE=sendgrid
EMAIL_SERVICE_API_KEY=your_production_sendgrid_key
EMAIL_FROM=noreply@citadeloftruth.university
EMAIL_FROM_NAME=Citadel of Truth

# ─── Authentication & Security ────────────────────────────────
# Generate strong tokens and store in secure vault
# Use AWS Secrets Manager, HashiCorp Vault, or environment
ADMIN_TOKEN=your_secure_production_admin_token
JWT_SECRET=your_secure_production_jwt_secret
JWT_EXPIRY=24h

# ─── Rate Limiting ────────────────────────────────────────────
API_RATE_LIMIT_WINDOW_MS=900000
API_RATE_LIMIT_MAX_REQUESTS=100

# ─── Feature Flags ────────────────────────────────────────────
ENABLE_CRON=true
ENABLE_AUTH=true
ENABLE_RATE_LIMITING=true
LOG_LEVEL=warn

# ─── CORS Configuration ───────────────────────────────────────
ALLOWED_ORIGINS=https://citadeloftruth.university

# ─── Monitoring & Error Tracking ──────────────────────────────
SENTRY_DSN=your_production_sentry_dsn
DATADOG_API_KEY=your_production_datadog_key
SLACK_WEBHOOK_URL=your_slack_webhook_for_alerts

# ─── Server Configuration ────────────────────────────────────
NODE_ENV=production
PORT=3000

# ─── TLS/HTTPS ────────────────────────────────────────────────
# Configure via reverse proxy (nginx, CloudFront, etc.)
# Certificate management via Let's Encrypt or your provider
SSL_CERT_PATH=/etc/ssl/certs/citadel.crt
SSL_KEY_PATH=/etc/ssl/private/citadel.key
HSTS_MAX_AGE=31536000

# ─── Backup Configuration ────────────────────────────────────
# Automated backup schedule
BACKUP_SCHEDULE=0 2 * * *
BACKUP_RETENTION_DAYS=30
BACKUP_STORAGE_PATH=/var/backups/citadel-of-truth
```

---

## Security Best Practices

### Token Generation

```bash
# Generate secure random tokens
node -e "
const crypto = require('crypto');
console.log('ADMIN_TOKEN=' + crypto.randomBytes(32).toString('hex'));
console.log('JWT_SECRET=' + crypto.randomBytes(32).toString('hex'));
"
```

### Environment Variable Safety

1. **Never commit .env files to Git**
   ```bash
   echo ".env*" >> .gitignore
   echo "!.env.example" >> .gitignore
   ```

2. **Use .env.example for template**
   ```bash
   # .env.example - commit this to Git, update as needed
   MONGODB_URI=mongodb://localhost:27017/citadel
   EMAIL_SERVICE=sendgrid
   EMAIL_SERVICE_API_KEY=your_key_here
   # ... etc
   ```

3. **Secure token storage in production**
   - Use AWS Secrets Manager
   - Use HashiCorp Vault
   - Use Azure Key Vault
   - Use environment-specific CI/CD secrets

4. **Rotate tokens regularly**
   - Admin token: Every 90 days
   - JWT secret: Every 180 days
   - API keys: As recommended by service provider

### Configuration Validation

```typescript
// src/lib/config-validator.ts
import { config } from './config';

export function validateConfig() {
  const required = [
    'MONGODB_URI',
    'EMAIL_SERVICE_API_KEY',
    'ADMIN_TOKEN',
    'JWT_SECRET'
  ];
  
  for (const key of required) {
    if (!process.env[key]) {
      throw new Error(`Missing required environment variable: ${key}`);
    }
  }
  
  console.log('✅ Configuration validated successfully');
}

// Call in server startup
if (process.env.NODE_ENV === 'production') {
  validateConfig();
}
```

---

## Configuration Files Location

```
project-root/
├── .env.local            # Development (git-ignored)
├── .env.staging          # Staging (git-ignored)
├── .env.production       # Production (git-ignored)
├── .env.example          # Template (version controlled)
├── .env.test             # Testing (version controlled)
└── .gitignore            # Excludes .env* files
```

---

## Loading Configuration by Environment

```typescript
// src/lib/config.ts
import { config as dotenvConfig } from 'dotenv';
import path from 'path';

// Load environment-specific file
const envFile = process.env.NODE_ENV === 'production'
  ? '.env.production'
  : process.env.NODE_ENV === 'staging'
  ? '.env.staging'
  : '.env.local';

dotenvConfig({ path: path.resolve(process.cwd(), envFile) });

export const config = {
  env: process.env.NODE_ENV || 'development',
  port: parseInt(process.env.PORT || '3000'),
  
  database: {
    uri: process.env.MONGODB_URI,
    poolSize: parseInt(process.env.MONGODB_POOL_SIZE || '5'),
  },
  
  email: {
    service: process.env.EMAIL_SERVICE,
    apiKey: process.env.EMAIL_SERVICE_API_KEY,
    from: process.env.EMAIL_FROM,
  },
  
  auth: {
    adminToken: process.env.ADMIN_TOKEN,
    jwtSecret: process.env.JWT_SECRET,
    jwtExpiry: process.env.JWT_EXPIRY || '24h',
  },
  
  security: {
    corsOrigins: (process.env.ALLOWED_ORIGINS || '').split(','),
    rateLimitWindow: parseInt(process.env.API_RATE_LIMIT_WINDOW_MS || '900000'),
    rateLimitMax: parseInt(process.env.API_RATE_LIMIT_MAX_REQUESTS || '100'),
  },
  
  features: {
    cronEnabled: process.env.ENABLE_CRON === 'true',
    authEnabled: process.env.ENABLE_AUTH === 'true',
    rateLimitingEnabled: process.env.ENABLE_RATE_LIMITING === 'true',
  },
  
  logging: {
    level: process.env.LOG_LEVEL || 'info',
    sentryDsn: process.env.SENTRY_DSN,
  },
};
```

---

## Deployment Instructions

### Development Setup
```bash
cp .env.example .env.local
# Edit .env.local with your settings
npm run dev
```

### Staging Deployment
```bash
# Push to staging branch
git checkout staging
git pull origin staging

# CI/CD loads .env.staging
# Deployment happens automatically
```

### Production Deployment
```bash
# Push to production branch
git checkout main
git pull origin main

# Manual pre-deployment checks
npm run test
npm run lint

# Deploy (via CI/CD with .env.production)
# Monitor health at: https://citadeloftruth.university/api/health
```
